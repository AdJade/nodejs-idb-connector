// Test Case 0817 -- The "INSERT" not working issue

var db = require('idb-connector');
var schema = "MOEXU";
var table = "TEST1";

var dbconn = new db.dbconn();
dbconn.debug(true)
dbconn.conn("*LOCAL");
var stmt = new db.dbstmt(dbconn);

function createSchemaSync(){
  var sql = "CREATE SCHEMA " + schema;
  console.log(sql);
  try {
    stmt.execSync(sql, function (result) {
      console.log("createSchema() " + schema + " has been created.");
    });
  } catch(ex) {
    console.log(ex);
  }
}

function createTableSync(){
  var sql = "CREATE TABLE " + schema + "." + table + "(id INTEGER GENERATED BY DEFAULT AS IDENTITY (START WITH 1) PRIMARY KEY, name varchar(256) not null)";
  console.log(sql);
  try {
    stmt.execSync(sql, function () {
      console.log("createTable() " + schema + "." + table + " has been created.");
    });
  } catch(ex) {
    createSchemaSync();
    createTableSync();
  }
}

function insertRowSync(myname){
  var sql = "insert into " + schema + "." + table + " (NAME) VALUES('" + myname +"')";
  console.log(sql);
  try {
    stmt.execSync(sql, function (result) {
      console.log("insertRow() 1 row has been added.");
    });
  } catch(ex) {
    createTableSync();
  }
}

function querySync(){
  var sql = "select * from " + schema + "." + table;
  console.log(sql);
  try {
    stmt.execSync(sql, function (result) {
      console.log(JSON.stringify(result));
      stmt.closeCursor();
    });
  } catch(ex) {
    console.log(ex);
  }
}

function insertRow(myname, cb){
  var sql = "insert into " + schema + "." + table + " (NAME) VALUES('" + myname +"')";
  console.log(sql);
  try {
    stmt.exec(sql, function (result, err) {
      if(err) console.log(err);
      else {
        console.log("insertRow() 1 row has been added.");
        cb();
      }
    });
  } catch(ex) {
    createTable();
  }
}

function query(){
  var sql = "select * from " + schema + "." + table;
  console.log(sql);
  try {
    stmt.exec(sql, function (result, err) {
      if(err) console.log(err);
      else console.log(JSON.stringify(result));
    });
  } catch(ex) {
    console.log(ex);
  }
}

insertRowSync("XUMENG");
querySync();

insertRow("MOE", query);